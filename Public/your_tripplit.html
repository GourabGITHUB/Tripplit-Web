<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <!-- Resource hints and preloads for performance -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Preload critical assets -->
  <link rel="preload" href="Images/logonobg.png" as="image" type="image/png">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" as="style">
  
  <title>Tripplit – Trip Expense Details</title>
  <meta name="description" content="View and manage all expenses on Tripplit. Track payments, split costs, and settle balances with your group in one simple web app.">
  
  <!-- Load fonts with optimized display strategy -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <style>
    /* Optimized loader - no artificial delay */
    #loader {
      position: fixed;
      width: 100%;
      height: 100%;
      background: #F8FAFC;
      z-index: 2147483647;
      display: flex;
      align-items: center;
      justify-content: center;
      will-change: transform, opacity;
      opacity: 1;
      transition: opacity 0.3s ease-out;
    }
    
    #loader.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    /* Spinner styling */
    #loader::after {
      content: "";
      width: 40px;
      height: 40px;
      border: 5px solid #abede3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      background-color: #57dbc7; 
    }
    
    /* Spinner animation */
    @keyframes spin {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }
    
    :root {
      /* New Color Palette */
      --bg-color: #F0F2F5;
      --bg-color: linear-gradient(
        180deg,
        #F8FAFC 0%, /* Very light blue-white at the top */
        #F0F2F5 100% /* Slightly darker cool gray at the bottom */
      );
      /* Light gray-blue background */
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --primary-color: #4a90e2; /* Vibrant blue for accents */
      --success-color: #4caf50;
      --danger-color: #e74c3c;
      --text-color: #2c3e50; /* Darker text */
      --light-text-color: #7f8c8d; /* Lighter text */
      --border-color: #bdc3c7;
      --transition-speed: 0.3s;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--light-text-color);
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      transition: background-color var(--transition-speed);
      opacity: 0;
      animation: fadeInBody 0.5s ease-in-out 0.1s forwards;
    }
    
    @keyframes fadeInBody {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Header Styles for Sticky Blur Effect */

@media (max-width: 600px) {
  .header div {
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.8rem 0.5rem;
  }
  .logo-link span {
    font-size: 1rem;
  }
  .back-btn {
    width: 100%;
    text-align: center;
  }
}

    
    #trip-name{
      text-transform: capitalize;
    }
    
    #participant-list{
      text-transform: capitalize;
    }
    
    /* Styling for the anchor tag itself */
    .logo-link {
      /* This is the key to making it a round container */
      position: relative;
      bottom: 0;
      left: 0;
      width: 100px;
      height: auto;
      /* This is crucial! It hides any part of the image that might stick out of the circle */
      /* Optional: adds a nice visual touch */
    }
    
    /* Styling for the image inside the anchor tag */
    .logo {
      /* Make the image fill the entire space of the parent .logo-link */
      width: 100%;
      height: 100%;
      /* This ensures the image covers the circle without being stretched or distorted */
    }
    
    .trip-info, .participant-section, .expense-section, .balance-section {
      padding: 2rem;
      border-radius: 1.5rem;
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 500px;
      margin-top: 1.5rem;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
    }
    
    /* Unique colors for each card/section */
    .trip-info {
      background: #F8F8F8; /* Fallback for browsers that don't support gradients */
      background: linear-gradient(
        135deg,
        #FFFFFF 0%, /* A very subtle white highlight at the top-left */
        #F8F8F8 60%,
        #EAEAEA 100% /* A slightly darker gray for depth at the bottom-right */
      );
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Adds a subtle shadow for a raised effect */
    }
    
    .participant-section {
      background: #EAF4F4; /* Fallback */
      background: linear-gradient(
        to bottom right,
        #F7FFFF 0%, /* A bright highlight */
        #EAF4F4 50%,
        #DCEBEB 100% /* A slightly darker mint for depth */
      );
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .expense-section {
      background: #FFF7E6; /* Fallback */
      background: linear-gradient(
        to right,
        #FFFFF7 0%, /* A creamy-white highlight */
        #FFF7E6 80%,
        #F3EACF 100% /* A slightly more saturated, darker yellow for depth */
      );
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .balance-section {
      background: #E9F0FB; /* Fallback */
      background: linear-gradient(
        to bottom,
        #F9FBFF 0%, /* A very light blue/white highlight at the top */
        #E9F0FB 50%,
        #DDE4F3 100% /* A slightly deeper periwinkle at the bottom */
      );
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .trip-info:hover, .participant-section:hover, .expense-section:hover, .balance-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }
    
    .trip-info h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      color: var(--text-color);
      font-weight: 700;
      letter-spacing: -0.05em;
    }
    
    .trip-info h1 i {
      color: var(--primary-color);
      font-size: 1.8rem;
    }
    
    .trip-info p {
      color: var(--light-text-color);
      font-size: 1rem;
      background: rgba(0,0,0,0.05);
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      margin-top: 0.75rem;
      word-break: break-word;
      text-align: center;
      font-weight: 500;
      border: 1px solid var(--border-color);
    }
    
    .participant-section h2, .expense-section h2, .balance-section h2 {
      font-size: 1.5rem;
      margin: 0;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background-color: rgba(0,0,0,0.05);
      border-radius: 1rem;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-color);
      transition: background-color var(--transition-speed);
      border: 1px solid var(--border-color);
    }
    
    .participant-section h2:hover, .expense-section h2:hover, .balance-section h2:hover {
      background-color: rgba(0,0,0,0.1);
    }
    
    .participant-form, .expense-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .participant-form input, .expense-form input, .expense-form select {
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 1rem;
      font-size: 1rem;
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
      width: 100%;
      box-sizing: border-box;
    }
    
    .participant-form input:focus, .expense-form input:focus, .expense-form select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }
    
    /* Input validation styling */
    .input-error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    
    .participant-form button, .expense-form button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
      box-shadow: 0 4px 10px rgba(74, 144, 226, 0.2);
    }
    
    .participant-form button:hover, .expense-form button:hover {
      background-color: #3b74b8;
      transform: translateY(-2px);
    }
    
    .participant-form button:disabled, .expense-form button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .participant-list {
      background-color: #F7FFFF;
      border: 2px dashed #b8c0cc;
      padding: 1.5rem;
      border-radius: 1rem;
      min-height: 5rem;
      color: var(--light-text-color);
      margin-top: 1.5rem;
      font-size: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .participant-list p {
      margin: 0;
    }
    
    .participant-list ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      color: var(--text-color);
      width: 100%;
    }
    
    .participant-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-color);
      animation: fadeIn var(--transition-speed) ease-in-out;
    }
    
    .participant-list li:last-child {
      border-bottom: none;
    }
    
    .participant-list li span {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
    }
    
    .participant-list li i.fa-user {
      color: var(--primary-color);
      font-size: 1.2rem;
    }
    
    .participant-list li i.fa-trash {
      color: var(--danger-color);
      cursor: pointer;
      font-size: 1rem;
      transition: transform var(--transition-speed);
    }
    
    .participant-list li i.fa-trash:hover {
      transform: scale(1.1);
    }
    
    .expense-disabled-message {
      font-size: 1rem;
      color: var(--light-text-color);
      background-color: rgba(0,0,0,0.05);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
      margin-top: 1.5rem;
    }
    
    #expense-list {
      margin-top: 1.5rem;
      background-color: #F7FFFF;
      padding: 1.5rem;
      border-radius: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    
    #expense-list h3 {
      margin-top: 0;
      font-size: 1.25rem;
      color: var(--text-color);
      font-weight: 700;
    }
    
    .expense-item {
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    
    .expense-item:last-child {
      border-bottom: none;
    }
    
    .expense-item .expense-details {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    
    .expense-item .expense-summary {
      font-weight: 700;
      color: var(--text-color);
    }
    
    .expense-item .expense-meta {
      font-size: 0.9rem;
      color: var(--light-text-color);
      margin-top: 0.2rem;
    }
    
    .expense-item .expense-actions i {
      font-size: 1rem;
      margin-left: 0.5rem;
      cursor: pointer;
      transition: transform var(--transition-speed);
    }
    
    .expense-item .expense-actions i:hover {
      transform: scale(1.1);
    }
    
    .expense-item i.fa-edit {
      color: var(--primary-color);
    }
    
    .expense-item i.fa-trash {
      color: var(--danger-color);
    }
    
    /* Dropdown Toggle Section */
    .participant-section h2 i.fa-users,
    .expense-section h2 i.fa-money-bill-wave,
    .balance-section h2 i.fa-receipt {
      color: var(--primary-color);
    }
    
    .toggle-icon {
      transition: transform 0.3s ease;
      font-size: 1.2rem;
    }
    
    .toggle-icon.rotate {
      transform: rotate(180deg);
    }
    
    #participant-content,
    #expense-content,
    #balance-content {
      transition: max-height 0.4s ease-in-out;
      max-height: 1000px;
      overflow: hidden;
      margin-top: 1rem;
    }
    
    [style*="display: none"] {
      max-height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .balance-summary, #settlement-history-container {
      background-color: #F7FFFF;
      border: 2px dashed #b8c0cc;
      padding: 1.5rem;
      border-radius: 1rem;
      color: var(--text-color);
      font-size: 1rem;
      text-align: left;
      margin-bottom: 1rem;
      text-transform: capitalize;
    }
    
    .balance-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }
    
    .balance-item:last-child {
      border-bottom: none;
    }
    
    .settle-btn {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-left: 0.5rem;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    
    .settle-btn:hover {
      background-color: #43a047;
      transform: translateY(-1px);
    }
    
    .clear-all-container {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    #clear-all-btn {
      font-size: 1rem;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--danger-color);
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
    }
    
    #clear-all-btn:hover {
      background-color: #d64032;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
    }
    
    #clear-all-btn:active {
      background-color: #c0392b;
      transform: translateY(0);
      box-shadow: none;
    }
    
    /* Styling for the custom dialog */
  #custom-dialog-overlay {
    position: fixed;
    top: 0;  /* Changed from 50% */
    left: 0; /* Changed from 50% */
    width: 100vw;  /* Use viewport units */
    height: 100vh; /* Use viewport units */
    transform: none; /* Remove transform */
    background-color: rgba(26, 26, 46, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000; /* Much higher than share button */
    transition: opacity 0.3s ease-in-out;
    padding: 1rem;
    box-sizing: border-box;
    overflow-y: auto;
    backdrop-filter: blur(2px); /* Optional: adds modern blur effect */
}

#custom-dialog {
    background-color: #ffffff;
    padding: 2.5rem;
    border-radius: 1.5rem;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    max-width: 450px;
    width: 90%;
    text-align: center;
    animation: slideInDialog 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-height: 80vh;
    overflow-y: auto;
    position: relative; /* Ensure it's positioned correctly */
}

#custom-dialog-overlay.hidden {
    opacity: 0;
    pointer-events: none;
    visibility: hidden; /* Add this for better hiding */
}

@keyframes slideInDialog {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
  
    
    #dialog-message {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      line-height: 1.6;
      color: var(--text-color);
    }
    
    #dialog-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    
    #dialog-buttons button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 1rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      font-weight: 600;
    }
    
    #dialog-buttons button.secondary {
      background-color: #ecf0f1;
      color: var(--text-color);
    }
    
    #dialog-buttons button.secondary:hover {
      background-color: #bdc3c7;
    }
    
    #dialog-buttons button.primary {
      background-color: var(--danger-color);
      color: #ffffff;
    }
    
    #dialog-buttons button.primary:hover {
      background-color: #d64032;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }
      
      .logo {
        height: 2rem; /* Reduce the height on smaller screens */
      }
      
      .loader-image {
        /* Reduce the size of the image on smaller screens */
        height: 80px;
      }
      
      .trip-info, .participant-section, .expense-section, .balance-section {
        padding: 1.5rem;
        margin-top: 1rem;
      }
      
      .trip-info h1 {
        font-size: 2rem;
        gap: 0.5rem;
      }
      
      .trip-info h1 i {
        font-size: 1.5rem;
      }
      
      .trip-info p {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }
      
      .participant-section h2, .expense-section h2, .balance-section h2 {
        font-size: 1.2rem;
      }
      
      .participant-form button, .expense-form button {
        padding: 0.75rem 1rem;
      }
      
      .participant-list, #expense-list {
        padding: 1rem;
      }
      
      .expense-item .expense-summary {
        font-size: 0.95rem;
      }
      
      #clear-all-btn {
        padding: 0.6rem 1rem;
      }
      
      #custom-dialog-overlay {
        padding-top: 5vh;
      }
      
      #custom-dialog {
        width: 95%;
        padding: 2rem;
        max-height: 85vh;
      }
    }
    
    @media (max-width: 480px) {
      #custom-dialog-overlay {
        padding-top: 2vh;
      }
      
      #custom-dialog {
        width: 98%;
        padding: 1.5rem;
        max-height: 90vh;
      }
    }
  #share-trip-btn {
  position: fixed;
  bottom: 2.5rem;
  right: 1.5rem;
  z-index: 1040;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 2rem;
  padding: 0.5rem 1rem 0.5rem 1rem;
  font-size: 1rem;
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(59,130,246,0.07);
  cursor: pointer;
  transition: background 0.16s, box-shadow 0.16s;
  display: flex;
  align-items: center;
  gap: 0.65em;
}
#share-trip-btn:hover, #share-trip-btn:focus {
  background: #2563eb;
  outline: none;
  box-shadow: 0 8px 28px rgba(59,130,246,0.11);
}
@media (max-width: 600px) {
  #share-trip-btn {
    right: 1rem;
    left: auto;
    bottom: 1rem;
    padding: 0.9rem 1.2rem;
    font-size: 1rem;
  }
}

  </style>
</head>
<body>
  <!-- Modern Responsive Header with Logo and Back to Home Only -->
  <header class="header" style="width: 100%;">
    <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:1rem;">
      <a href="/" class="logo-link" style="display:flex;align-items:center;gap:1rem;text-decoration:none;">
        <img src="Images/logonobg.png" alt="Trip Expense Tracker Logo" class="logo" style="height:48px;width:auto;">
        <span style="font-size:1.35rem;font-weight:700;color:#1f2937;letter-spacing:-0.02em;"></span>
      </a>
      <nav>
        <a href="/" class="back-btn" style="
          background: #3b82f6;
          color: white;
          padding: 0.7rem 1.3rem;
          border-radius: 0.6rem;
          border: none;
          font-weight: 600;
          font-size: 1rem;
          text-decoration: none;
          transition: background 0.2s;
          box-shadow: 0 2px 10px rgba(59,130,246,0.06);
        ">← Back to Home</a>
      </nav>
    </div>
  </header> 
  <!-- Optimized loader - removed artificial delay -->
  <div id="loader">
    <img src="Images/logonobg.png" alt="Trip Expense Tracker Logo" class="loader-image">
  </div>


  <div class="trip-info">
    <h1><i class="fas fa-route"></i> <span id="trip-name">Trip</span></h1>
    <p id="trip-id"></p>
  </div>
  
  <!-- Participants Section -->
  <div class="participant-section">
    <h2 onclick="toggleSection('participant-content')" style="cursor: pointer;">
      <i class="fas fa-users"></i> Participants
      <i class="fas fa-chevron-down toggle-icon" id="participant-toggle-icon" style="float: right;"></i>
    </h2>
    <div id="participant-content">
      <div class="participant-list" id="participant-list">
        <p>No participants yet. Add some!</p>
      </div>
      <form id="participant-form" class="participant-form">
        <input type="text" id="participant-name" placeholder="Enter name" required />
        <div class="error-message" id="participant-name-error"></div>
        <button type="submit">Add</button>
      </form>
    </div>
  </div>
  
  <!-- Expenses Section -->
  <div class="expense-section">
    <h2 onclick="toggleSection('expense-content')" style="cursor: pointer;">
      <i class="fas fa-money-bill-wave"></i> Expenses
      <i class="fas fa-chevron-down toggle-icon" id="expense-toggle-icon" style="float: right;"></i>
    </h2>
    <div id="expense-content">
      <form id="expense-form" class="expense-form" style="display: none">
        <input type="text" id="expense-category" placeholder="Expense category" required />
        <div class="error-message" id="expense-category-error"></div>
        <input type="number" id="expense-amount" placeholder="Amount" step="0.01" required />
        <div class="error-message" id="expense-amount-error"></div>
        <select id="expense-paid-by"></select>
        <button type="submit">Add Expense</button>
      </form>
      <div id="expense-list" style="display: none">
        <h3>Expense Items</h3>
        <div id="expense-items"></div>
      </div>
      <div class="clear-all-container">
        <button id="clear-all-btn" class="danger-btn">Clear All Expenses & Settlements</button>
      </div>
    </div>
  </div>
  
  <!-- Balance summary-->
  <div class="balance-section">
    <h2 onclick="toggleSection('balance-content')">
      <i class="fas fa-receipt"></i> Balance Summary
      <i id="balance-toggle-icon" class="fas fa-chevron-down toggle-icon rotate"></i>
    </h2>
    <div id="balance-content" style="display: none;">
      <div id="balance-summary" class="balance-summary">
        <p>Balances will be calculated and shown here.</p>
      </div>
      <div id="settlement-history-container" class="section-container">
        <h3>Settlement History</h3>
        <div id="settlement-history-list"></div>
      </div>
    </div>
  </div>

  <div id="custom-dialog-overlay" class="hidden">
    <div id="custom-dialog">
      <p id="dialog-message"></p>
      <div id="dialog-buttons"></div>
    </div>
  </div>
<button id="share-trip-btn" title="Share this trip" aria-label="Share this trip">
  <i class="fas fa-share-alt"></i> Share Trip
</button>

  <script>
    // Constants for validation
    const MAX_NAME_LENGTH = 50;
    const MIN_NAME_LENGTH = 1;
    const MAX_CATEGORY_LENGTH = 100;
    const MIN_AMOUNT = 0.01;
    const MAX_AMOUNT = 999999.99;

    // Input sanitization function
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      
      // Remove HTML tags and script content
      const htmlTagRegex = /<[^>]*>/g;
      const scriptRegex = /<script[^>]*>.*?<\/script>/gi;
      
      return input
        .replace(scriptRegex, '')
        .replace(htmlTagRegex, '')
        .trim();
    }

    // Validation functions
    function validateName(name) {
      const errors = [];
      
      if (!name || name.length === 0) {
        errors.push('Name is required');
      }
      
      if (name.length < MIN_NAME_LENGTH) {
        errors.push(`Name must be at least ${MIN_NAME_LENGTH} character`);
      }
      
      if (name.length > MAX_NAME_LENGTH) {
        errors.push(`Name must not exceed ${MAX_NAME_LENGTH} characters`);
      }
      
      // Check for malicious patterns
      const maliciousPatterns = [
        /javascript:/i,
        /data:text\/html/i,
        /vbscript:/i,
        /<script/i,
        /on\w+\s*=/i
      ];
      
      for (const pattern of maliciousPatterns) {
        if (pattern.test(name)) {
          errors.push('Name contains invalid characters');
          break;
        }
      }
      
      return {
        isValid: errors.length === 0,
        errors: errors
      };
    }

    function validateCategory(category) {
      const errors = [];
      
      if (!category || category.length === 0) {
        errors.push('Category is required');
      }
      
      if (category.length > MAX_CATEGORY_LENGTH) {
        errors.push(`Category must not exceed ${MAX_CATEGORY_LENGTH} characters`);
      }
      
      // Check for malicious patterns
      const maliciousPatterns = [
        /javascript:/i,
        /data:text\/html/i,
        /vbscript:/i,
        /<script/i,
        /on\w+\s*=/i
      ];
      
      for (const pattern of maliciousPatterns) {
        if (pattern.test(category)) {
          errors.push('Category contains invalid characters');
          break;
        }
      }
      
      return {
        isValid: errors.length === 0,
        errors: errors
      };
    }

    function validateAmount(amount) {
      const errors = [];
      const numAmount = parseFloat(amount);
      
      if (isNaN(numAmount)) {
        errors.push('Amount must be a valid number');
      } else {
        if (numAmount < MIN_AMOUNT) {
          errors.push(`Amount must be at least ${MIN_AMOUNT}`);
        }
        
        if (numAmount > MAX_AMOUNT) {
          errors.push(`Amount must not exceed ${MAX_AMOUNT}`);
        }
      }
      
      return {
        isValid: errors.length === 0,
        errors: errors
      };
    }

    function showError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + '-error');
      
      if (field && errorDiv) {
        field.classList.add('input-error');
        errorDiv.textContent = message;
      }
    }

    function clearErrors() {
      const errorMessages = document.querySelectorAll('.error-message');
      const errorFields = document.querySelectorAll('.input-error');
      
      errorMessages.forEach(error => error.textContent = '');
      errorFields.forEach(field => field.classList.remove('input-error'));
    }

    // Firebase loading flag
    let firebaseLoaded = false;

    // Load Firebase SDK dynamically
    async function loadFirebaseSDK() {
      if (firebaseLoaded) return;
      
      try {
        // Dynamically import the main script
        await import('./your_tripplit.js');
        firebaseLoaded = true;
        console.log('✅ Firebase SDK and main script loaded successfully');
      } catch (error) {
        console.error("❌ Error loading Firebase SDK:", error);
      }
    }

    // Optimized page load sequence - no artificial delay
    function hideLoader() {
      const loader = document.getElementById("loader");
      loader.classList.add('fade-out');
      setTimeout(() => {
        loader.style.display = 'none';
      }, 300);
    }

    // Immediate DOM-ready functions
    window.addEventListener("DOMContentLoaded", function() {
      // Hide loader immediately - no artificial delay
      hideLoader();
      
      // Start loading Firebase in the background
      setTimeout(() => {
        loadFirebaseSDK();
      }, 100); // Small delay to let initial render complete
    });

    // Fallback for older browsers
    window.addEventListener("load", function() {
      if (document.readyState !== 'complete') {
        hideLoader();
      }
    });

    function toggleSection(id) {
      const content = document.getElementById(id);
      const iconMap = {
        'participant-content': 'participant-toggle-icon',
        'expense-content': 'expense-toggle-icon',
        'balance-content': 'balance-toggle-icon'
      };
      const icon = document.getElementById(iconMap[id]);
      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
      icon.classList.toggle('rotate', !isHidden);
    }

    // Enhanced form validation with sanitization
    document.addEventListener('DOMContentLoaded', function() {
      // Real-time validation for participant name
      const participantNameInput = document.getElementById('participant-name');
      if (participantNameInput) {
        participantNameInput.addEventListener('input', function() {
          const sanitized = sanitizeInput(this.value);
          const validation = validateName(sanitized);
          
          if (!validation.isValid && sanitized.length > 0) {
            showError('participant-name', validation.errors[0]);
          } else {
            clearErrors();
          }
        });
      }

      // Real-time validation for expense category
      const expenseCategoryInput = document.getElementById('expense-category');
      if (expenseCategoryInput) {
        expenseCategoryInput.addEventListener('input', function() {
          const sanitized = sanitizeInput(this.value);
          const validation = validateCategory(sanitized);
          
          if (!validation.isValid && sanitized.length > 0) {
            showError('expense-category', validation.errors[0]);
          } else {
            const errorDiv = document.getElementById('expense-category-error');
            if (errorDiv) errorDiv.textContent = '';
            this.classList.remove('input-error');
          }
        });
      }

      // Real-time validation for expense amount
      const expenseAmountInput = document.getElementById('expense-amount');
      if (expenseAmountInput) {
        expenseAmountInput.addEventListener('input', function() {
          const validation = validateAmount(this.value);
          
          if (!validation.isValid && this.value.length > 0) {
            showError('expense-amount', validation.errors[0]);
          } else {
            const errorDiv = document.getElementById('expense-amount-error');
            if (errorDiv) errorDiv.textContent = '';
            this.classList.remove('input-error');
          }
        });
      }
    });

    // Make sanitization functions globally available for the main script
    window.sanitizeInput = sanitizeInput;
    window.validateName = validateName;
    window.validateCategory = validateCategory;
    window.validateAmount = validateAmount;
    window.showError = showError;
    window.clearErrors = clearErrors;

    // Helper: Get Trip ID (adjust selector if needed)
function getTripId() {
  const tripElement = document.getElementById('trip-id');
  let id = '';
  if (tripElement) {
    // Extract just the code, trimming if contents label text
    id = tripElement.textContent ? tripElement.textContent.trim() : '';
    // Optionally parse if format is e.g. "Trip ID: ABC123"
    if (/[:：]\s*(\w{4,})$/.test(id)) {
      id = id.match(/[:：]\s*(\w{4,})$/)[1];
    }
  }
  return id || '[unknown]';
}

// Share logic
document.getElementById('share-trip-btn').addEventListener('click', async function () {
  const tripId = getTripId();
  const shareText = `Join my Tripplit group!\nTrip code: ${tripId}\nOpen in Tripplit: https://tripplit-200.web.app/?id=${encodeURIComponent(tripId)}`;

  // Native browser share (mobile, modern desktop)
  if (navigator.share) {
    try {
      await navigator.share({
        title: 'Join my Tripplit group!',
        text: shareText,
        url: `https://tripplit-200.web.app/?id=${encodeURIComponent(tripId)}`
      });
      return;
    } catch (err) {
      // Fallback to clipboard if sharing was cancelled/error
    }
  }

  // Clipboard API fallback
  try {
    await navigator.clipboard.writeText(shareText);
    showTemporaryShareNotification('Trip link copied to clipboard!');
  } catch (err) {
    showTemporaryShareNotification('Unable to copy. Please copy manually.');
  }
});

// Temporary feedback
function showTemporaryShareNotification(msg) {
  let notif = document.getElementById('share-toast');
  if (!notif) {
    notif = document.createElement('div');
    notif.id = 'share-toast';
    notif.style.position = 'fixed';
    notif.style.bottom = '5.5rem';
    notif.style.right = '2rem';
    notif.style.background = '#1d4ed8';
    notif.style.color = '#fff';
    notif.style.padding = '0.8rem 1.7rem';
    notif.style.borderRadius = '2rem';
    notif.style.boxShadow = '0 4px 18px rgba(59,130,246,0.13)';
    notif.style.fontWeight = '500';
    notif.style.zIndex = '1050';
    notif.style.fontSize = '1rem';
    notif.style.opacity = '0.9';
    document.body.appendChild(notif);
  }
  notif.textContent = msg;
  notif.style.display = 'block';
  clearTimeout(notif._timer);
  notif._timer = setTimeout(() => {
    notif.style.display = 'none';
  }, 2200);
}

function showCustomDialog(message, buttons) {
    return new Promise((resolve) => {
        const dialogOverlay = document.getElementById("custom-dialog-overlay");
        const dialogMessage = document.getElementById("dialog-message");
        const dialogButtonsContainer = document.getElementById("dialog-buttons");
        
        dialogMessage.textContent = message;
        dialogButtonsContainer.innerHTML = '';
        
        buttons.forEach(btnConfig => {
            const button = document.createElement("button");
            button.textContent = btnConfig.text;
            button.className = btnConfig.className;
            button.addEventListener("click", () => {
                dialogOverlay.classList.add("hidden");
                // Re-enable body scroll
                document.body.style.overflow = '';
                document.body.style.position = '';
                resolve(btnConfig.value);
            });
            dialogButtonsContainer.appendChild(button);
        });
        
        // Prevent body scroll to lock the background
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        
        // Show the dialog
        dialogOverlay.classList.remove("hidden");
        
        // Force immediate visibility and focus
        requestAnimationFrame(() => {
            // Ensure dialog is visible
            dialogOverlay.style.display = 'flex';
            
            // Focus first button for accessibility
            const firstButton = dialogButtonsContainer.querySelector("button");
            if (firstButton) {
                setTimeout(() => firstButton.focus(), 100);
            }
        });
    });
}

// Add this helper function to your code
function preventBodyScroll() {
    const scrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollY}px`;
    document.body.style.width = '100%';
    document.body.style.overflow = 'hidden';
    return scrollY;
}

function restoreBodyScroll(scrollY) {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.style.overflow = '';
    window.scrollTo(0, scrollY);
}

import { dbPromise } from './firebase-config.js';
import {
    doc,
    updateDoc,
    arrayUnion,
    arrayRemove,
    onSnapshot,
    runTransaction,
    addDoc,
    collection
} from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

const db = await dbPromise;

const params = new URLSearchParams(window.location.search);
const tripId = params.get("id");
const tripRef = doc(db, "trips", tripId);

const tripNameElem = document.getElementById("trip-name");
const tripIdElem = document.getElementById("trip-id");
const participantListElem = document.getElementById("participant-list");
const participantForm = document.getElementById("participant-form");
const participantInput = document.getElementById("participant-name");

const expenseForm = document.getElementById("expense-form");
const expenseCategoryInput = document.getElementById("expense-category");
const expenseAmountInput = document.getElementById("expense-amount");
const expensePaidBySelect = document.getElementById("expense-paid-by");
const expenseListContainer = document.getElementById("expense-list");
const expenseItems = document.getElementById("expense-items");
const loader = document.getElementById("loader");


let currentTrip = null;

// 🔹 Helper: Generate unique ID for each expense
function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9);
}

// -------------------------------------------------------------
// MAIN REAL-TIME LISTENER
// -------------------------------------------------------------
onSnapshot(tripRef, (docSnap) => {
    if (!docSnap.exists()) return;

    const tripData = docSnap.data();
    const participants = tripData.participants || [];
    const expenses = tripData.expenses || [];

    renderParticipants(participants, expenses);
    renderExpenses(expenses); // ✅ UPDATED: This now filters settlements
    updatePaidByOptions(participants);

    // 🔢 New function
    calculateBalances(participants, expenses);
    renderSettlementHistory(expenses)

    tripNameElem.textContent = tripData.name;
    tripIdElem.textContent = `Trip ID: ${tripId}`;

    const hasParticipants = participants.length > 0;
    expenseForm.style.display = hasParticipants ? "flex" : "none";
    expenseListContainer.style.display = hasParticipants ? "block" : "none";
});

// -------------------------------------------------------------
// PARTICIPANT FORM LOGIC
// -------------------------------------------------------------
participantForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = participantInput.value.trim();
    if (!name) return;

    try {
        await updateDoc(tripRef, {
            participants: arrayUnion(name),
        });
        participantInput.value = "";
    } catch (err) {
        console.error("Error adding participant:", err);
    }
});

participantInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        participantForm.dispatchEvent(new Event("submit"));
    }
});

function renderParticipants(participants, expenses = []) {
    if (!participants.length) {
        participantListElem.innerHTML = "<p>No participants yet. Add some!</p>";
        return;
    }

    participantListElem.innerHTML = "<ul></ul>";
    const ul = participantListElem.querySelector("ul");

    participants.forEach(name => {
        const li = document.createElement("li");

        const userSpan = document.createElement("span");
        userSpan.innerHTML = `<i class="fas fa-user"></i> ${name}`;

        const deleteBtn = document.createElement("i");
        deleteBtn.className = "fas fa-trash";
        deleteBtn.title = "Remove";

        deleteBtn.addEventListener("click", async () => {
            try {
                const usedInExpense = expenses.some(exp => exp.paidBy === name);
                if (usedInExpense) {
                    const confirmed = await showCustomDialog(
                        `⚠️ "${name}" has paid for some expenses. Deleting them may cause data inconsistency. Do you want to continue?`,
                        [
                            { text: "Cancel", className: "secondary", value: false },
                            { text: "Continue", className: "primary", value: true }
                        ]
                    );
                    
                    if (!confirmed) {
                        return;
                    }
                }

                // ✅ The updateDoc logic remains the same
                await updateDoc(tripRef, {
                    participants: arrayRemove(name),
                });

            } catch (err) {
                console.error("Error removing participant:", err);
                // ✅ REPLACED: Native alert() with custom dialog
                showCustomDialog(
                    "Error removing participant. Please try again.",
                    [{ text: "OK", className: "secondary", value: true }]
                );
            }
        });

        li.appendChild(userSpan);
        li.appendChild(deleteBtn);
        ul.appendChild(li);
    });
}
function updatePaidByOptions(participants) {
    expensePaidBySelect.innerHTML = "";
    participants.forEach(p => {
        const option = document.createElement("option");
        option.value = p;
        option.textContent = p;
        expensePaidBySelect.appendChild(option);
    });
}

// -------------------------------------------------------------
// EXPENSE FORM LOGIC
// -------------------------------------------------------------
expenseForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const category = expenseCategoryInput.value.trim();
    const amount = parseFloat(expenseAmountInput.value.trim());
    const paidBy = expensePaidBySelect.value;

    if (!category || isNaN(amount) || !paidBy) {
        alert("Please fill all fields correctly.");
        return;
    }

    const newExpense = {
        id: generateId(),
        category,
        amount,
        paidBy,
        timestamp: Date.now(),
        isSettlement: false, // ✅ NEW: added a flag for non-settlement expenses
    };

    try {
        await updateDoc(tripRef, {
            expenses: arrayUnion(newExpense),
        });

        expenseCategoryInput.value = "";
        expenseAmountInput.value = "";
    } catch (err) {
        console.error("Error adding expense:", err);
    }
});

function renderExpenses(expenses) {
    const expenseItemsDiv = document.getElementById("expense-items");
    expenseItemsDiv.innerHTML = "";

    // ✅ UPDATED: Filter out settlement transactions
    const nonSettlementExpenses = expenses.filter(exp => !exp.isSettlement);

    if (!nonSettlementExpenses || nonSettlementExpenses.length === 0) {
        expenseItemsDiv.innerHTML = "<p>No expenses added yet.</p>";
        return;
    }

    nonSettlementExpenses.forEach(exp => {
        const item = document.createElement("div");
        item.className = "expense-item";

        const details = document.createElement("div");
        details.className = "expense-details";
        details.innerHTML = `
      <div class="expense-summary">${exp.category} - ₹${exp.amount}</div>
      <div class="expense-meta">Paid by: ${exp.paidBy}</div>
    `;

        const actions = document.createElement("div");

        const editIcon = document.createElement("i");
        editIcon.className = "fas fa-edit";
        editIcon.title = "Edit amount";
        editIcon.addEventListener("click", () =>
            editExpenseAmount(exp.id, tripId, exp.amount)
        );

        const deleteIcon = document.createElement("i");
        deleteIcon.className = "fas fa-trash";
        deleteIcon.title = "Delete expense";
        deleteIcon.addEventListener("click", () =>
            deleteExpense(exp.id, tripId)
        );

        actions.appendChild(editIcon);
        actions.appendChild(deleteIcon);

        item.appendChild(details);
        item.appendChild(actions);
        expenseItemsDiv.appendChild(item);
    });
}

// -------------------------------------------------------------
// EXPENSE EDIT & DELETE LOGIC
// -------------------------------------------------------------
// This is your corrected deleteExpense function
async function deleteExpense(expenseId, tripId) {
    const tripRef = doc(db, "trips", tripId);
    try {
        await runTransaction(db, async (transaction) => {
            const tripSnap = await transaction.get(tripRef);
            if (!tripSnap.exists()) throw new Error("Trip not found");
            const tripData = tripSnap.data();

            // ✅ CORRECTED LOGIC: Filter out the expense to be deleted AND all settlements
            const updatedExpenses = (tripData.expenses || [])
                .filter(exp => exp.id !== expenseId && !exp.isSettlement);
            
            transaction.update(tripRef, {
                expenses: updatedExpenses,
                isFullySettled: false // Resetting the flag
            });
        });
    } catch (err) {
        console.error("Failed to delete expense (transaction):", err);
    }
}
// This is your corrected editExpenseAmount function
async function editExpenseAmount(expenseId, tripId, currentAmount) {
    const newAmount = prompt("Enter new amount:", currentAmount);
    if (newAmount === null || isNaN(parseFloat(newAmount))) return;
    const parsedAmount = parseFloat(newAmount);
    const tripRef = doc(db, "trips", tripId);
    try {
        await runTransaction(db, async (transaction) => {
            const tripSnap = await transaction.get(tripRef);
            if (!tripSnap.exists()) throw new Error("Trip not found");
            const tripData = tripSnap.data();
            
            // ✅ CORRECTED LOGIC: Create a new array without settlements
            let updatedExpenses = (tripData.expenses || []).filter(exp => !exp.isSettlement);

            // Now, map over the new array to update the specific expense
            updatedExpenses = updatedExpenses.map(exp =>
                exp.id === expenseId ? { ...exp, amount: parsedAmount } : exp
            );
            
            transaction.update(tripRef, {
                expenses: updatedExpenses,
                isFullySettled: false // Resetting the flag
            });
        });
    } catch (err) {
        console.error("Failed to update expense amount (transaction):", err);
    }
}// -------------------------------------------------------------
// BALANCE CALCULATION & RENDERING
// -------------------------------------------------------------
function renderBalanceSummary(netBalances, settlements) {
    const balanceSummaryDiv = document.getElementById("balance-summary");
    balanceSummaryDiv.innerHTML = "";

    // 👥 Net Balances
    netBalances.forEach((balance, name) => {
        const item = document.createElement("div");
        item.className = "balance-item";
        const label = document.createElement("div");
        label.textContent = `${name}:`;
        const value = document.createElement("div");
        value.textContent = balance >= 0 ?
            `Gets ₹${balance.toFixed(2)}` :
            `Owes ₹${Math.abs(balance).toFixed(2)}`;
        value.style.color = balance >= 0 ? "#10b981" : "#ef4444";
        item.appendChild(label);
        item.appendChild(value);
        balanceSummaryDiv.appendChild(item);
    });

    // 🔄 Settlement List
    if (settlements.length > 0) {
        const header = document.createElement("h4");
        header.textContent = "Settlement Summary:";
        header.style.marginTop = "1rem";
        balanceSummaryDiv.appendChild(header);

        // A container for all settlement items
        const settlementListUl = document.createElement("ul");
        settlementListUl.id = "settlement-list"; // Give it an ID to attach a listener
        balanceSummaryDiv.appendChild(settlementListUl);
        
        settlements.forEach(s => {
            const listItem = document.createElement("li");
            listItem.className = "settlement-item";
            const row = document.createElement("div");
            row.className = "balance-item";
            const label = document.createElement("div");
            label.textContent = `${s.from} owes ${s.to}`;
            const amount = document.createElement("div");
            amount.textContent = `₹${s.amount.toFixed(2)}`;
            amount.style.fontWeight = "600";
            const settleBtn = document.createElement("button");
            settleBtn.textContent = "Settle";
            settleBtn.className = "settle-btn";
            settleBtn.setAttribute("data-from", s.from);
            settleBtn.setAttribute("data-to", s.to);
            settleBtn.setAttribute("data-amount", s.amount);
            row.appendChild(label);
            row.appendChild(amount);
            row.appendChild(settleBtn);
            listItem.appendChild(row);
            settlementListUl.appendChild(listItem);
        });
    }
}

// This is your new, final calculateBalances function
function calculateBalances(participants, expenses, isLocalCheck = false) { // isLocalCheck added to prevent infinite loop
    
    // ✅ NEW: Check the isFullySettled flag first
    if (!isLocalCheck && currentTrip && currentTrip.isFullySettled) {
        renderBalanceSummary(new Map(), []);
        return; // Exit early if the trip is settled
    }

    const paymentMap = new Map();
    let totalOriginalExpense = 0;

    participants.forEach(name => paymentMap.set(name, 0));

    const settlements = [];
    const originalExpenses = [];
    expenses.forEach(exp => {
        if (exp.isSettlement) {
            settlements.push(exp);
        } else {
            originalExpenses.push(exp);
            if (paymentMap.has(exp.paidBy)) {
                paymentMap.set(exp.paidBy, paymentMap.get(exp.paidBy) + exp.amount);
                totalOriginalExpense += exp.amount;
            }
        }
    });

    const perPersonShare = participants.length > 0 ? totalOriginalExpense / participants.length : 0;
    const netBalances = new Map();
    const finalBalancesArray = [];

    participants.forEach(name => {
        const paid = paymentMap.get(name);
        const balance = paid - perPersonShare;
        netBalances.set(name, balance);
        finalBalancesArray.push(balance);
    });

    settlements.forEach(settlement => {
        const payerBalance = netBalances.get(settlement.paidBy);
        const recipientBalance = netBalances.get(settlement.settles);
        netBalances.set(settlement.paidBy, payerBalance + settlement.amount);
        netBalances.set(settlement.settles, recipientBalance - settlement.amount);
    });

    if (isLocalCheck) {
        return finalBalancesArray; // Return the balances for the local check
    }

    const debtors = [];
    const creditors = [];

    netBalances.forEach((amount, name) => {
        if (amount < -0.01) {
            debtors.push({ name, amount: Math.abs(amount) });
        } else if (amount > 0.01) {
            creditors.push({ name, amount });
        }
    });

    debtors.sort((a, b) => b.amount - a.amount);
    creditors.sort((a, b) => b.amount - a.amount);

    const finalSettlements = [];

    while (debtors.length && creditors.length) {
        const debtor = debtors[0];
        const creditor = creditors[0];
        const settleAmount = Math.min(debtor.amount, creditor.amount);
        finalSettlements.push({
            from: debtor.name,
            to: creditor.name,
            amount: settleAmount
        });
        debtor.amount -= settleAmount;
        creditor.amount -= settleAmount;
        if (Math.abs(debtor.amount) < 0.01) debtors.shift();
        if (Math.abs(creditor.amount) < 0.01) creditors.shift();
    }
    
    renderBalanceSummary(netBalances, finalSettlements);
}
// -------------------------------------------------------------
// SETTLEMENT BUTTON EVENT LISTENER
// -------------------------------------------------------------
// This replaces the old event listener for the "Settle" button
document.getElementById("balance-summary").addEventListener("click", async (e) => {
    if (e.target.classList.contains("settle-btn")) {
        const from = e.target.getAttribute("data-from");
        const to = e.target.getAttribute("data-to");
        const amount = parseFloat(e.target.getAttribute("data-amount"));

        const confirm1 = await showCustomDialog(`Confirm that ${from} has paid ${to} ₹${amount.toFixed(2)}?`,
            [
                            { text: "Cancel", className: "secondary", value: false },
                            { text: "Continue", className: "primary", value: true }
                        ]);
        if (!confirm1) return;

        const confirm2 = await showCustomDialog(`❌ This is a final warning. Click OK to confirm the payment from ${from} to ${to} for ₹${amount.toFixed(2)}`,

           [
                            { text: "Cancel", className: "secondary", value: false },
                            { text: "Ok", className: "primary", value: true }
                        ]);
        if (!confirm2) {
            alert("Settlement cancelled.");
            return;
        }

        try {
            await runTransaction(db, async (transaction) => {
                const tripSnap = await transaction.get(tripRef);
                if (!tripSnap.exists()) throw "Trip does not exist!";
                const tripData = tripSnap.data();
                const expenses = tripData.expenses || [];

                const newSettlement = {
                    id: generateId(),
                    category: `Settlement from ${from}`,
                    amount: amount,
                    paidBy: from,
                    settles: to,
                    isSettlement: true,
                    timestamp: Date.now()
                };

                const updatedExpenses = [...expenses, newSettlement];
                
                // Re-run balance calculation locally to check if all debts are cleared
                const tempBalances = calculateBalances(tripData.participants, updatedExpenses, true);
                const isAllSquare = tempBalances.every(b => Math.abs(b) < 0.01);
                
                transaction.update(tripRef, {
                    expenses: updatedExpenses,
                    isFullySettled: isAllSquare // ✅ NEW: Set the settlement flag
                });
            });
            showCustomDialog(
                `Settlement of ₹${amount.toFixed(2)} from ${from} to ${to} recorded.`,
                [{ text: "OK", className: "secondary", value: true }]
            );

        } catch (err) {
            console.error("Error recording settlement:", err);
showCustomDialog(
                "Failed to record settlement. Try again.",
                [{ text: "OK", className: "secondary", value: true }]
            );        }
    }
});
// This function needs to be added to your JavaScript file
function renderSettlementHistory(expenses) {
    const historyListDiv = document.getElementById("settlement-history-list");
    historyListDiv.innerHTML = ""; // Clear existing records

    // Filter for only settlement transactions
    const settlementRecords = expenses.filter(exp => exp.isSettlement);

    if (settlementRecords.length === 0) {
        historyListDiv.innerHTML = "<p>No settlement records yet.</p>";
        return;
    }

    const ul = document.createElement("ul");
    settlementRecords.forEach(record => {
        const li = document.createElement("li");
        li.className = "settlement-record-item";

        // Create a user-friendly timestamp
        const date = new Date(record.timestamp).toLocaleDateString();

        // Create the display text
        li.innerHTML = `
            <span class="settlement-details">
                ${record.paidBy} settled ₹${record.amount.toFixed(2)} with ${record.settles}.
            </span>
            <span class="settlement-date">
                (on ${date})
            </span>
        `;
        ul.appendChild(li);
    });

    historyListDiv.appendChild(ul);
}
// This function needs to be added to your JavaScript file
// This is a new function, so it's best to place it with your other event listeners

// This is your updated event listener for the Clear All button
// This is your updated event listener for the Clear All button
document.getElementById("clear-all-btn").addEventListener("click", async () => {
    // Replaced the first native confirm() with our custom dialog
    const confirmed1 = await showCustomDialog(
        "⚠️ Are you sure you want to clear ALL expenses and settlements?",
        [
            { text: "Cancel", className: "secondary", value: false },
            { text: "Continue", className: "primary", value: true }
        ]
    );

    if (!confirmed1) {
        return;
    }

    // Replaced the second native confirm() with our custom dialog
    const confirmed2 = await showCustomDialog(
        "❌ This will PERMANENTLY erase all trip data. Are you absolutely sure?",
        [
            { text: "No", className: "secondary", value: false },
            { text: "Yes, clear data", className: "primary", value: true }
        ]
    );

    if (!confirmed2) {
        return;
    }

    // Perform the database update after both custom confirmations
    try {
        await updateDoc(tripRef, {
            expenses: [],
            isFullySettled: false,
        });
        // We can even use our custom dialog for the final alert!
        showCustomDialog(
            "All expenses and settlements have been cleared.",
            [{ text: "OK", className: "secondary", value: true }]
        );
    } catch (err) {
        console.error("Error clearing all data:", err);
        showCustomDialog(
            "Failed to clear all data. Please try again.",
            [{ text: "OK", className: "secondary", value: true }]
        );
    }finally{
            loader.style.display = "none";
    }
});

  </script>


</body>
</html>
